<!DOCTYPE html>
<html>


<!-- HEAD -->

<head>
  <meta charset="utf-8">
  <title>zadatak</title>

  <meta name="author" content="Nebojsa Konstantinovic">

  <!-- Bootstrap -->
  <link href="css/bootstrap.css" rel="stylesheet">

  <!--CSS -->
  <link href="css/style.css" rel="stylesheet" type="text/css" />
  <link href="css/responsive.css" rel="stylesheet" type="text/css" />

</head>


<!-- BODY -->

<body>

  <div class="wrap">

    <div class="cont">

      <h1>Aircraft Traffic Flow</h1>

      <div class="" id="lonlat">


      </div>


      <div class="" id="result">

      </div>

      <!-- Modal -->
      <div class="modal fade" id="airCraftModal" tabindex="-1" role="dialog" aria-labelledby="airCraftModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <figure id="logo"></figure>
              <h5 class="modal-title" id="airCraftModalLabel"></h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
            </div>
            <div class="modal-body">
              <p>Aircraft manufacturer:<span id="man"></span></p>
              <p>Aircraft model:<span id="mdl"></span></p>
              <p>From:<span id="from"></span></p>
              <p>To:<span id="to"></span></p>

            </div>
          </div>
        </div>
      </div>


      <!--zatvaranje kontejnera -->
    </div>

  </div>



  <!-- SCRIPTS  -->

  <!-- automatska geolokacija -->
  <script>
    var x = document.getElementById("lonlat");
    var lat;
    var lon;

    //1

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(handlePosition);
    }

    //2

    function handlePosition(position) {
      x.innerHTML = '<h5>Above Your Position</h5>' +
        '<p>Latitude: ' + position.coords.latitude + '</p>' +
        '<p>Longitude: ' + position.coords.longitude + '</p>';
      lat = position.coords.latitude;
      lon = position.coords.longitude;
      getResults();
      setInterval(eraseData,59000);
      setInterval(getResults,60000);
    }

    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(handlePosition, handleError);
    }


    //3

    function handleError(error) {
      switch (error.code) {
        case error.PERMISSION_DENIED:
          // User denied access to location. Perhaps redirect to alternate content?
          x.innerHTML = '<h5 class="error">It is necessary to Allow Location Access</h5>' + '<p class="error">Please reload page</p>';
          break;
        case error.POSITION_UNAVAILABLE:
          x.innerHTML = '<h5 class="error">Position is currently unavailable</h5>';
          break;
        case error.UNKNOWN_ERROR:
          x.innerHTML = '<h5 class="error">An unknown error occurred</h5>'
          break;
      }
    }
  </script>


  <script type="text/javascript">
    function eraseData() {
      document.getElementById('result').innerHTML = '';
    }
  </script>


  <!-- get server -->

  <script type="text/javascript">

//////////////////////100km, ako se kod gleda uvece treba povecati search radijus

    function getServer(x, y) {
      return 'http://public-api.adsbexchange.com/VirtualRadar/AircraftList.json?lat=' + x + '&lng=' + y + '&fDstL=0&fDstU=100';
    }
  </script>






  <!-- getPicture function -->

  <script type="text/javascript">
    function getPicture(arg) {
      if (arg < 180) {
        var picture = '<figure><img src="img/aircraft-east.png" alt="img-plane-east"></figure>'
      } else if (arg > 180) {
        var picture = '<figure><img src="img/aircraft-west.png" alt="img-plane-west"></figure>'
      } else {
        var picture = '<p>plane is going south or north</p>'
      }
      return picture;
    };
  </script>

  <!-- Sort acList -->

  <script type="text/javascript">
    function compare(a, b) {

      let comparison = 0;
      if (a.Alt < b.Alt) {
        comparison = 1;
      } else if (a.Alt > b.Alt) {
        comparison = -1;
      }
      return comparison;
    }

    //planes.sort(compare);
  </script>

  <!-- getLogo function -->

  <script type="text/javascript">
    function getLogo(arg) {
      var pic = arg.replace(/\s/g, '').toLowerCase() + '.com';
      return '<img src="http://logo.clearbit.com/' + pic + '?size=40">'
    };
  </script>







  <script>

    // AJAX request



    ////////////////////
    ///////////////////////////////////////////

    //funkcija za modal

    function showPlane(plane) {
      //console.log(plane);
      document.getElementById('airCraftModalLabel').innerHTML = plane.Call
      document.getElementById('man').innerHTML = plane.Man
      document.getElementById('mdl').innerHTML = plane.Mdl
      document.getElementById('from').innerHTML = plane.From;
      document.getElementById('to').innerHTML = plane.To;
      document.getElementById('logo').innerHTML = getLogo(plane.Op);
      $('#airCraftModal').modal();
      console.log(getLogo(plane.Op));

    }

    function makeTd(val) {
      var td = document.createElement('td');
      td.innerHTML = val;
      return td;
    }

    function makeTh(val) {
      var th = document.createElement('th');
      th.innerHTML = val;
      return th;
    }

    function makeRow(plane) {
      var tr = document.createElement('tr');
      tr.appendChild(makeTd(getPicture(plane.Trak)));
      tr.appendChild(makeTd(plane.Alt));
      tr.appendChild(makeTd(plane.Call));
      tr.addEventListener('click', function() {
        showPlane(plane);
      }, false);
      return tr;
    }

    function makeHeadRow() {
      var tr = document.createElement('tr');
      tr.appendChild(makeTh('West/East'));
      tr.appendChild(makeTh('Altitude(ft)'));
      tr.appendChild(makeTh('Flight code No'));
      return tr;
    }


    function getResults() {
      $.post({
        url: getServer(lat, lon),
        dataType: "jsonp"
      }).then(function(response) {
        var planes = response.acList;
        planes.sort(compare);


        var tblContainer = document.createElement('table');

        var tblHead = document.createElement('thead');
        tblContainer.appendChild(tblHead);

        tblHead.appendChild(makeHeadRow());

        var tblBody = document.createElement('tbody');
        tblContainer.appendChild(tblBody);

        planes.forEach(function(plane) {
          tblBody.appendChild(makeRow(plane));
        });
        document.getElementById('result').appendChild(tblContainer);
      });
    }

    //'http://public-api.adsbexchange.com/VirtualRadar/AircraftList.json?lat=33.433638&lng=-112.008113&fDstL=0&fDstU=100'

    //getServer(lat,lon)
  </script>


  <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
  <script src="js/jquery.min.js" type="text/javascript"></script>
  <script src="js/popper.js" type="text/javascript"></script>
  <!-- Include all compiled plugins (below), or include individual files as needed -->
  <script src="js/bootstrap.min.js"></script>
  <script src="js/main.js" type="text/javascript"></script>


</body>

</html>
